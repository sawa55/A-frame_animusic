<html>

<head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
        AFRAME.registerComponent('audioanalyser', {
            schema: {
                src: { type: 'selector' },
                scaleFactor: { type: 'number', default: 12 }
            },

            init: function () {
                var audioContext = this.el.sceneEl.audioListener.context;
                var analyser = this.analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // FFTサイズを設定
                this.data = new Uint8Array(analyser.frequencyBinCount);
                console.log(this.el.dataset.scaleFactor)
                // var scaleFactor = this.el.getAttribute('audioanalyser').scaleFactor;

                var sound = this.el.components.sound;
                if (sound && sound.loaded) {
                    console.log("true")

                    var source = sound.pool.children[0].getOutput(); // soundコンポーネントからAudioNodeを取得
                    source.connect(analyser); // AudioNodeをAnalyserNodeに接続
                } else {
                    console.log("false")
                    this.el.addEventListener('sound-loaded', () => {
                        var source = sound.pool.children[0].getOutput();
                        source.connect(analyser);
                    });
                }
            },

            tick: function () {
                this.analyser.getByteFrequencyData(this.data);
                var sum = this.data.reduce((a, b) => a + b, 0);
                var average = sum / this.data.length;
                var scaleFactor = this.schema.scaleFactor;
                // console.log(this.schema)

                var newScale = 1 + (average / 64) * this.el.dataset.scaleFactor; // 平均ボリュームに基づいてスケールを計算
                this.el.setAttribute('scale', { x: newScale, y: newScale, z: newScale });
            }

        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var audioStarted = false;
            document.addEventListener('keydown', function (event) {
                if (event.key === 'c') {
                    var scene = document.querySelector('a-scene');
                    var myAudio = document.getElementById('myAudio');
                    if (!audioStarted) {
                        scene.audioListener.context.resume().then(() => {
                            console.log('AudioContext activated');
                            var soundComponents = document.querySelectorAll('[sound]');
                            soundComponents.forEach(function (soundComponent) {
                                soundComponent.components.sound.playSound();
                            });
                            myAudio.play();
                            audioStarted = true;
                        });
                    }
                }
            });
        });
    </script>

</head>

<body>
    <audio id="myAudio" src="Short.mp3" autoplay:true loop:true></audio>
    <a-scene>
        <a-sky color="#ECECEC"></a-sky>
        <a-box data-scale-factor="20" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"
            sound="src: url(bass.mp3); loop: true" audioanalyser="src: a-sound;"></a-box>
        <a-box data-scale-factor="6" position="1 0.5 -6" rotation="0 45 0" color="#4CC3D9"
            sound="src: url(hat.mp3); loop: true" audioanalyser="src: a-sound;"></a-box>
        <a-box data-scale-factor="12" position="1 0.5 3" rotation="0 45 0" color="#4CC3D9"
            sound="src: url(melody.mp3); loop: true" audioanalyser="src: a-sound;"></a-box>
    </a-scene>
</body>

</html>